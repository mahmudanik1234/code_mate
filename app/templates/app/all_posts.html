<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Blog Posts</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <!-- Prism.js CSS (can keep or remove since we use Monaco now) -->
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet" />

  <style>
    /* Monaco editor container style */
    .monaco-editor-container {
      height: 300px;
      border-radius: 0.375rem; /* rounded-2 */
      background-color: #1e1e1e; /* dark background */
      margin-top: 1rem;
    }
  </style>
</head>
<body class="bg-dark text-light pb-5" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
  <div class="container mt-4">
    <h1 class="mb-4"><i class="fas fa-blog me-2"></i>All Blog Posts</h1>

    {% if post_list %}
      {% for item in post_list %}
      <article class="bg-dark bg-opacity-50 rounded-3 shadow-lg p-4 mb-4 border border-secondary border-opacity-25">
        <h2 class="fw-bold mb-1">{{ item.post.title }}</h2>

        <!-- Description -->
        {% if item.post.description %}
          <p class="mb-3 text-white-50">{{ item.post.description }}</p>
        {% endif %}

        <div class="mb-3 opacity-75">
          <span class="me-3 small"><i class="fas fa-user me-1"></i> {{ item.post.author.username }}</span>
          <span class="small"><i class="fas fa-clock me-1"></i>{{ item.post.created_at|date:"M d, Y H:i" }}</span>
        </div>

        <!-- Tabs for languages -->
        <ul class="nav nav-tabs" id="tab-{{ item.post.id }}" role="tablist">
          {% for code in item.codes %}
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if forloop.first %}active{% endif %}" 
                      id="tab-{{ code.language }}-{{ item.post.id }}" 
                      data-bs-toggle="tab" 
                      data-bs-target="#{{ code.language }}-{{ item.post.id }}" 
                      type="button" role="tab">
                {% if code.language == 'python' %}
                  <i class="fab fa-python me-1 fs-5"></i>
                {% elif code.language == 'java' %}
                  <i class="fab fa-java me-1 fs-5"></i>
                {% elif code.language == 'cpp' %}
                  <i class="fas fa-code me-1 fs-5"></i>
                {% endif %}
                {{ code.language|title }}
              </button>
            </li>
          {% endfor %}
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3">
          {% for code in item.codes %}
            <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                 id="{{ code.language }}-{{ item.post.id }}" 
                 role="tabpanel">

              {% if code.code %}
                <div class="position-relative mt-3">
                  <button class="btn btn-secondary btn-sm position-absolute top-0 end-0 mt-2 me-2" 
                          style="z-index: 10; transition: background-color 0.3s ease;" 
                          onclick="copyCode(this)"
                          onmouseover="this.classList.add('btn-outline-light')"
                          onmouseout="this.classList.remove('btn-outline-light')">
                    <i class="fas fa-copy me-1"></i>Copy
                  </button>
                  <!-- Monaco Editor container -->
                  <div id="monaco-{{ code.language }}-{{ item.post.id }}" 
                       class="monaco-editor-container"></div>
                </div>
              {% else %}
                <div class="text-muted text-center p-4">
                  <p>No {{ code.language|title }} code available for this post.</p>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </article>
      {% endfor %}
    {% else %}
      <div class="alert alert-warning text-center mt-5">
        <i class="fas fa-folder-open fa-3x mb-3"></i>
        <h3>No Posts Available</h3>
        <p>Check back later for amazing code snippets!</p>
      </div>
    {% endif %}
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Monaco Editor loader -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.39.0/min/vs/loader.js"></script>

  <script>
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.39.0/min/vs' }});
    require(['vs/editor/editor.main'], function() {
      // Prepare all editors on page load
      {% for item in post_list %}
        {% for code in item.codes %}
          (function() {
            var codeContent = `{{ code.code|escapejs }}`;
            var language = "{{ code.language }}";

            // Monaco uses 'cpp' for C++ language mode
            if(language === 'cpp') language = 'cpp';
            else if(language === 'python') language = 'python';
            else if(language === 'java') language = 'java';

            monaco.editor.create(document.getElementById('monaco-{{ code.language }}-{{ item.post.id }}'), {
              value: codeContent,
              language: language,
              readOnly: true,
              automaticLayout: true,
              minimap: { enabled: false },
              theme: 'vs-dark',
              fontSize: 14,
              lineNumbers: 'on',
              wordWrap: 'on',
            });
          })();
        {% endfor %}
      {% endfor %}
    });

    function copyCode(btn) {
      // Find the monaco editor container next to the button
      const container = btn.nextElementSibling;
      if (!container) return;

      // Monaco editor instance is attached to the container, but can't get the text easily from DOM
      // So use Monaco's API:
      const editor = monaco.editor.getEditors().find(e => e.getDomNode() === container);
      if (editor) {
        const codeText = editor.getValue();
        navigator.clipboard.writeText(codeText).then(() => {
          btn.classList.remove('btn-secondary');
          btn.classList.add('btn-success');
          btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
          setTimeout(() => {
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
            btn.innerHTML = '<i class="fas fa-copy me-1"></i>Copy';
          }, 2000);
        });
      }
    }
  </script>
</body>
</html>
